<!-- client.html -->

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>exat</title>
    <link rel="shortcut icon" type="image⁄x-icon" href="https://lh3.googleusercontent.com/GthzQWUsD3S0zOesCwIkjqTLeyrm9hUDPoasUHLT_vf3PNujeRbU7C5Pz1jBWxpF-P3SCnAw3Y2FafsjjP_o=w1920-h942">
    <style>
    html, body {
    	width: 100%; height: 100%;
      border: none;
      margin: 0px;
    padding: 0px;
    }
    body{
      overflow-y:hidden;
    }
    ::-webkit-scrollbar { width: 5.2px; } /* 스크롤 바 */
::-webkit-scrollbar-track { background-color:white; } /* 스크롤 바 밑의 배경 */
::-webkit-scrollbar-thumb { background: #dcdcdc; } /* 실질적 스크롤 바 */
::-webkit-scrollbar-thumb:hover { background: #dcdcdc; } /* 실질적 스크롤 바 위에 마우스를 올려다 둘 때 */
::-webkit-scrollbar-thumb:active { background: #dcdcdc; } /* 실질적 스크롤 바를 클릭할 때 */
::-webkit-scrollbar-button { display: none; } /* 스크롤 바 상 하단 버튼 */
      #chatLog{ width: 100%; height: 100%;white-space: pre-wrap;overflow:auto;}
      body{background-color: #4c394b;overflow-x: hidden;}
      .name{ width: 5%; }
      .message{ width: 95%;background-color:white;border:none;height: 25px;vertical-align: text-top;display: inline-block;height: 90%;background-color: #efefef;}
      #out{color:gray;}
      #join{color:gray;}
      #me{color:#FFBF00;}
      #divdiv2{width: 100%; height: 84%;
        background-color: white;
      }#name{display:none;}
      #divmain{
        display: inline-block;
        width:calc(100% - 280px);
        height:100%;
        background-color: #f3f3f3;
        position:absolute;
      }
      #da{
        color:#3d3d3d;
        font-size: 20px;
      }
      #namename{
        font-size: 10px;
        color:gray;
      }
      #myple{
        float: right;
      }
      #mas{
        border-radius: 0px 5px 5px 5px;
        background-color: #f1f1f1;
        display: inline-block;
        animation: fadeIn 0.2s;
      }
      #masmy{
        border-radius: 5px 0px 5px 5px;
        background-color: #EDEFF7;
        display: inline-block;
        float: right;
        animation: fadeIn 0.2s;
      }
      #but1{
        display: inline-block;
        height: 11px;
        width: 11px;
        border-radius: 10px;
        background-color:white;
        cursor:pointer
      }
      #texst{
        background: linear-gradient( to right, #dee5ef, white );
        display: inline-block;
        width: 50%;
      }
      #contant{
        width:100%;
        height:70px;
        background-color:white;
        text-align: left;
      }
      #wname{
        color:#6f6f6f;
        font-size: 17px;
      }
      #divbr{
        height:3px;
      }
      #divbrmy{
        height:6px;
      }
      #divbrr{display: inline-block;width: 10px;}
      #div2{
        height:7px;
      }
      #divv2{
        display: inline-block;
        width: 1px;
      }
      #joined{
        display: inline-block;
        width: 70px;
        height: 100%;
        background-color:#3d303c;
      }
      #mesdiv{
        display: inline-block;
        width: 97%;
        background-color:#efefef;
        border-radius: 5px;
        border:none;height: 25px;
        vertical-align: text-top;
      }
      #div3{
        display: inline-block;
        width: 3px;
      }
      #div33{
        display: inline-block;
        width: 10px;
      }
      input:focus {
        outline: none;
      }
      #div0{
        display: inline-block;
        width: 20px;
        height: 100%;
      }
      #online{
        left: calc(100% - 100px);
        position: absolute;
      }
      #onliin{
        color:#858585;
        font-size: 12px;
      }
      #inli{
        height: 100%;
        width: 10px
      }
      #inlii{
        display: inline-block;
        width: 10px;
        height: 20px;
      }
      #in{
        display: inline-block;
      }
      #in2{
        display: inline-block;
        width: 10px;
        height: 1px;
      }
      #diib3{
        height: 10px;
      }
      #onlinemember{
        height: 25px;
        display: inline-block;
      }
      #onlinename{
        color: #5b5b5b;
      }
      #onlined{
        color: #aaaaaa;
        font-size: 12px;
      }
      #my{
        overflow:auto;
      }
      @keyframes fadeIn {
        from{
          opacity: 0;
        }
        to{
          opacity: 1;
        }
      }
      #login{
        position: fixed;
        z-index: 1;
        opacity: 0.5;

        width:100%;
        height: 100%;
        background-color: black;
      }
      #logindiv{
        display: inline-block;
        background-color: white;
        top:50%;
        left:50%;
        transform: translate(-50%,-50%);
        position: fixed;
        z-index: 2;
        width: 450px;
        height: 400px;
        border-radius:30px;
      }
      #upload{
        display: inline-block;
        background-color: white;
        top:50%;
        left:50%;
        transform: translate(-50%,-50%);
        position: fixed;
        z-index: 3;
        width: 450px;
        height: 400px;
        border-radius:30px;
      }
      #divi3{height: 100px;}
      #divv5{display: inline-block;width: 100px;}
      #divv6{display: inline-block;width: 130px;}
      #id{width: 220px;height: 30px;border: none;background-color: #F2F2F2;text-align: center;border-radius:30px;}
      #ps{width: 220px;height: 30px;border: none;background-color: #F2F2F2;text-align: center;border-radius:30px;}
      #dd{height: 10px}
      #ok{width: 170px;height: 50px;border: none;border-radius:15px;background-color:#4b89dc;color: white;}
      #mention{display: inline-block;background-color: #EDEFF7;color:#7289E0;border-radius:5px;}
      #writing{height: 20px;}
      #writingg{font-size: 11px;color: #A4A4A4;}
      #ex_file{opacity:0;width: 10px;height: 10px;position: fixed;}
      #divjoin1{height: 20px;}
      #divjoin2{display: inline-block;width: 20px;}
      #plejoin{font-size:20px;color:#666666;}
      #plejoin1{font-size:13px;color:#666666;}
      #room:hover{transition: all 0.25s;background-color: #82687f;box-shadow: 0px 0px 5px 1px #efefef;}
      #aafsdaf:hover{
        transition: all 0.25s;
        border-radius: 30px;
        background-color: #82687f;
      }
      #aafsdaf{
        margin:0 auto;height:60px;width:60px;display:inline-block;background-color:#382a36;border-radius: 17px;text-align:center;transition: all 0.25s;
      }
      #room{transition: all 0.25s;}
      #makeroom{height: 70px;background-color:#312430;text-align: center;}
      #asd{color:#4d3a4b;font-size: 30px;line-height: 100%;}
      #channell{display: inline-block;height: 100%;width: 200px;background-color: #4c394b;position: fixed;z-index: 2}
      #div22{display: inline-block;width: 200px;background-color:#3a133e;}
      #chat{background-color: white;}
      #divvdi{
        display: inline-block;
        width:calc(100% - 70px);
        position: fixed;
        background-color: #f9f9f9;
        z-index: -1;
        height: 100%;
      }
      #channels{
        display: inline-block;
        width: 100%;
        transition: all 0.2s;
      }
      #channels:hover{
        opacity: 0.2;
        transition: all 0.2s;
      }
      #asdffdsa{
        background-color: #3d303c;
        height: 70px;
      }
      #asdffff{
        position: fixed;
        display: inline-block;
        width: 100px;
        height: 70px;
        background-color: #3d303c;
        z-index: -1;
      }
      #hoomicon{
        display: inline-block;
        width: 40px;
        height: 40px;
        border-radius: 10px 10px 0px 10px;
        background-color: white;
        opacity: 0.1;
      }
      #mentions{
        display: inline-block;
        width: 100%;
        transition: all 0.2s;
      }
      #mentions:hover{
        opacity: 0.2;
        transition: all 0.2s;
      }
    </style>
  </head>
  <body>
    <div id="asdffff"></div>
    <div id="login">
    </div>
    <div id="logindiv">
      <div id="divi3"></div>
      <div id="divv5"></div>
      <input type="text" id="id"placeholder="id">
      <div id="dd"></div>
      <div id="divv5"></div>
      <input type="password" id="ps"placeholder="ps">
      <div id="divi3"></div>
      <div id="divv6"></div>
      <input type="button" id="ok" value="login">
    </div>
    <div id="joined">
      <div id="makeroom" onclick="makero();">
        <div style="height:14px;"></div>
        <div id="hoomicon"></div>
      </div>
      <!--시작-->
      <!--끝-->
    </div>
    <div id="channell">
      <div id="asdffdsa">
      <div style="height:8px;"></div>
      <div style="display: inline-block;width:8px;"></div>
      <ple style="color:white;font-size:25px;"><strong>main</strong></ple><div></div>
      <div style="display: inline-block;width:8px;"></div>
      <ple style="color:white;opacity:0.3;font-size:12px;"><strong>#배정받지 못한자들의 방</strong></ple>
      </div>

      <div>
        <div style="height:70px;"></div>
        <div style="display: inline-block;width:8px;"></div>
        <ple style="color:white;opacity:0.5;font-size:16px;"onclick="make();">Channels</ple>
        <!--div style="display:inline-block;width:11px;height:11px;background-color:white;opacity:0.2;border-radius:2px;"><font style="">+</font></div-->
        <!--asd-->
        <div></div>
        <div id="chann">
          <div id="channels">
            <div style="display: inline-block;width:14px;"></div><ple style="color:white;opacity:0.2;font-size:16px">#</ple>
            <ple style="color:white;opacity:0.7;font-size:14px">시작입니다</ple>
          </div>
        </div>

      </div>
      <div>
        <div style="height:70px;"></div>
        <div style="display: inline-block;width:8px;"></div>
        <ple style="color:white;opacity:0.5;font-size:16px;">Direct Message</ple>
        <!--asd-->
        <div></div>
        <div id="chansn">
          <div id="mentions">
            <div style="display: inline-block;width:14px;"></div><ple style="color:white;opacity:0.2;font-size:16px">●</ple>
            <ple style="color:white;opacity:0.7;font-size:14px">exmuh(나)</ple>
          </div>
          <div id="mentions">
            <div style="display: inline-block;width:14px;"></div><ple style="color:white;opacity:0.2;font-size:16px">○</ple>
            <ple style="color:white;opacity:0.7;font-size:14px">ex</ple>
          </div>
        </div>

      </div>
    </div>
    <div id="div22"></div>
    <div id="divmain">
      <div id="contant">
        <div style="height:20px;"></div>
        <div style="display:inline-block;width:10px;"></div>
        <ple id="asd"><strong>#기본채팅방</strong></ple>
      </div>
      <div id="divdiv2">
        <div id="chatLog" class="chatlog" readonly></div>
      </div>
      <form id="chat">
      <div id="div2"></div>
      <div id="div3"></div>
      <div id="mesdiv">
      <div id="div0">
        <div id="divv2"></div>
        <div id="but1" onclick="img();"><input type="file" id="ex_file"accept="image/png, image/jpeg"></div>
      </div>
      <input id="message" class="message" type="text" autocomplete="off">
      </div>
      <div id="writing">
      </div>
      </form>
    </div>
    <div id="divvdi"></div>
    <input id="name" class="name" type="text" readonly>
    <div id="box" class="box">
    <script src="/socket.io/socket.io.js"></script> <!-- 1 -->
    <script src="//code.jquery.com/jquery-1.11.1.js"></script>
    <script>
    let nowchannel="Main Chat";
    function make(){
      var namee = prompt("채널 이름을 설정해 주세요");
      socket.emit('makechannel',namee,roomname,name);
    }
    let roomiso;
    let roommessage="";
    function makero(){
      var namee = prompt("방 이름을 설정해 주세요");
      var nameee = prompt("방 설명을 설정해 주세요");
      socket.emit('makeronm',namee,name,nameee);
    }
    function changechannel(chan){
      nowchannel=chan;
      var messageroom=roommessage[roomroomname.indexOf(roomname)].split("asdf!@#$%");
      var message23=roomchannelff[roomroomname.indexOf(roomname)].split("asdf!@#$%");
      roomuserr=roomiso[roomroomname.indexOf(roomname)]
      for(var a=1;a<messageroom.length;a++){
        var message2=messageroom[a].split(":><:");
        if(message23[a]==nowchannel){
        socket.emit('send message',name+"<<<<<<<%:"+message2[0],message2[1],roomname,nowchannel);
        }
      }
      $("#chatLog").html(`<div id='texst'><strong id="join">+${name}</strong><br></div><div id="divbr"></div>`);
    }
    let roomchannels;
    let roomname="main";
    let ronamelast="";
    //$("#ex_file").hide();
    function img(){

    }
    Notification.requestPermission(function() {
    if (Notification.permission === 'granted') {}
    });
    let doing="고양이 놀아주는중";
    document.getElementById("ok").onclick = function(){
        console.log("okko");
        name = document.getElementById("id").value;
        ps = document.getElementById("ps").value;
        myy=1;
        socket.emit('take');
      }
      let myy=0;
      let onuser;
      let onusers;
      $('#message').val('');
      let lastuser="";
      var socket = io(); //1
      $('#chat').on('submit', function(e){ //2
        socket.emit('send message', $('#name').val(), $('#message').val(),roomname,nowchannel);
        $('#message').val('');
        $('#message').focus();
        e.preventDefault();
      });
      socket.on('receive message', function(msg,chansa){ //3
        if(msg.indexOf("asdf")!=-1){
          var msgmsg=msg.split("asdf");
          msg=msgmsg[1];
          if(msgmsg[0]!=name){
            return 0;
          }
        }
        else if(chansa!=nowchannel){
          return 0;
        }
        var i=msg.split(":></324");
        if(i[2]==roomname){
        var isd=msg.split("@");
        if(isd[1]!=undefined){
          if(mention(i[1],onuser)){
            var aasd=i[1].indexOf("@");
            var newss=i[1];
            var men=mention(i[1],onuser);
            socket.emit('mention1',newss.substr(aasd+1,mention(i[1],onuser)));
            i[1]=newss.substr(0, aasd)+"<div id='mention'><strong>"+newss.substr(aasd,mention(i[1],onuser)+1)+"</strong></div>"+newss.substr(aasd+mention(i[1],onuser)+1,newss.length);
          }
        }
        if(i[0]!=$('#name').val()){
          if(lastuser==i[0]){
            $('#chatLog').append("<ple>  </ple><div id='mas'><ple id='da'>"+i[1]+'</ple><div id="divbrr"></div><div id="divbr"></div></div><div id="divbr"></div>');
          }
          else{
            lastuser=i[0];
            $('#chatLog').append("<ple>  </ple><a id='wname'>"+i[0]+"</a><br><div id='my'><ple>  </ple><ple id='myple'>  </ple><div id='mas'><ple id='da'>"+i[1]+'</ple><div id="divbrr"></div><div id="divbr"></div></div><ple>  </ple></div><div id="divbr"></div>');
          }
        }
        else{
          lastuser=i[0];
          $('#chatLog').append("<div id='my'><ple id='myple'>  </ple><div id='masmy'><ple id='da'>"+i[1]+'</ple><div id="divbrr"></div><div id="divbr"></div></div><ple>  </ple></div><div id="divbrmy"></div>');
        }
        $('#chatLog').scrollTop($('#chatLog')[0].scrollHeight);
      }
      autolink($('.chatlog'));
      });
      socket.on('change name', function(name){ //4
        $('#name').val(name);
      });
      socket.on('mention', function(named){ //4
        if(name=named){
          if(doing!="온라인"){
            console.log(named);
            new Notification('알림', { body: '누군가 당신을 맨션했습니다!', icon: 'https://lh3.googleusercontent.com/GthzQWUsD3S0zOesCwIkjqTLeyrm9hUDPoasUHLT_vf3PNujeRbU7C5Pz1jBWxpF-P3SCnAw3Y2FafsjjP_o=w1920-h942' });
          }
        }
      });
      socket.on('out', function(name){ //4
        $('#chatLog').append(`<div id='texst'><strong id="out">-`+name+'</strong><br></div><div id="divbr"></div>');
      });
      socket.on('join', function(name){ //4
        $('#chatLog').append(`<div id='texst'><strong id="join">+`+name+'</strong><br></div><div id="divbr"></div>');
      });
      let ps;
      let name;
      socket.on('calltake',function(userr,pss){
        if(myy!=0){
          myy=0;
        if(userr.indexOf(name)==-1){
          if(name.length>0&&name.length<10){
          jQuery('#login').hide();
          jQuery('#logindiv').hide();
          socket.emit('joinn',name,ps,1);
          $('#name').val(name)
          }
          else{
            alert("1글자이상 9글자 이하로 정해주세요");
          }
        }
        else{
          var psd=pss[userr.indexOf(name)];
          if(psd==ps){
            jQuery('#login').hide();
            jQuery('#logindiv').hide();
            socket.emit('joinn',name,ps,0);
            $('#name').val(name)
          }
          else{
            alert("이미 있는 계정입니다/비밀번호가 잘못됨")
          }
        }
        }
      });
      let roomuserr="";
      let roomroomname="";
      let dodd;
      function myroom(roomd){
        nowchannel="Main Chat";
        lastuser="";
        roomname=roomd;
        var messageroom=roommessage[roomroomname.indexOf(roomname)].split("asdf!@#$%");
        var message23=roomchannelff[roomroomname.indexOf(roomname)].split("asdf!@#$%");
        roomuserr=roomiso[roomroomname.indexOf(roomname)]
        for(var a=1;a<messageroom.length;a++){
          var message2=messageroom[a].split(":><:");
          if(message23[a]==nowchannel){
          socket.emit('send message',name+"<<<<<<<%:"+message2[0],message2[1],roomname,nowchannel);
          }
        }
        $("#chatLog").html(`<div id='texst'><strong id="join">+${name}</strong><br></div><div id="divbr"></div>`);
        $("#asdffdsa").html(`<div style="height:8px;"></div>
        <div style="display: inline-block;width:8px;"></div>
        <ple style="color:white;font-size:25px;"><strong>${roomname}</strong></ple><div></div>
        <div style="display: inline-block;width:8px;"></div>
        <ple style="color:white;opacity:0.3;font-size:12px;"><strong>${roomuserr}</strong></ple>`);
      }
      let rorohtml=$("#joined").html();
      let lastruof="";
      let roomchannelff="";
      socket.on('receive online', function(users,userss,dod,roname,rouser,romessage,roomis,roomchannel,roomchannelf){ //4
        roomchannelff=roomchannelf;
        roomchannels=roomchannel;
        roommessage=romessage;
        roomiso=roomis;
        roomroomname=roname;
        var ruof=``

        var oisg=roomchannels[roname.indexOf(roomname)];
        var dfg=oisg.split("asdf2903u");
        for(var a=0;a<dfg.length;a++){
          ruof=ruof+`<div id="channels" onclick="changechannel('${dfg[a]}')">
          <div style="display: inline-block;width:14px;"></div><ple style="color:white;opacity:0.2;font-size:16px">#</ple>
          <ple style="color:white;opacity:0.7;font-size:14px">${dfg[a]}</ple></div>`
        }
        if(lastruof!=ruof){
          $("#chann").html(ruof);
          lastruof=ruof;
        }
        var rohtml=rorohtml;
        for(var a=0;a<roname.length;a++){
          if(roname[a]!=0){
            rohtml=rohtml+`
            <div style="display:inline-block;width:70px;height:70px;text-align:center;">
              <div style="height:10px;"></div>
              <div id="aafsdaf" onclick="myroom('${roname[a]}');">
              <div style="height:11px;"></div>
              <ple style="color:white;opacity:0.5;">${roname[a]}</ple>
              </div>
            </div>
            `
          }
        }
        if(ronamelast!=rohtml){
          $("#joined").html(rohtml+`
            <div style="display:inline-block;width:70px;height:70px;text-align:center;">
              <div style="height:10px;"></div>
              <div id="aafsdaf" onclick="makero();">
              <ple style="color:white;opacity:0.5;font-size:40px;">+</ple>
              </div>
            </div>
            `);
          ronamelast=rohtml;
        }
        onuser=users;
        onusers=userss;
        dodd=dod;
        var tag=``
        var writtting="";
        for(var i=0;i<onuser.length;i++){
          if(onuser[i]==0){}
          else{
            if(dodd[i]=="글쓰는중"){
              tag=tag+`<div id="mentions"><div style="display: inline-block;width:14px;"></div><ple style="color:white;opacity:0.2;font-size:16px">●</ple>
              <ple style="color:white;opacity:0.7;font-size:14px">${onuser[i]}</ple></div>`
            }
            else{
              if(dodd[i]=="온라인"){
                tag=tag+`<div id="mentions"><div style="display: inline-block;width:14px;"></div><ple style="color:white;opacity:0.2;font-size:16px">●</ple>
                <ple style="color:white;opacity:0.7;font-size:14px">${onuser[i]}</ple></div>`
              }
              else{
                tag=tag+`<div id="mentions"><div style="display: inline-block;width:14px;"></div><ple style="color:white;opacity:0.2;font-size:16px">○</ple>
                <ple style="color:white;opacity:0.7;font-size:14px">${onuser[i]}</ple></div>`
              }
          }
          if(dodd[i]=="글쓰는중" && onuser[i]!=name){
            if(writtting==""){writtting=onuser[i];}
            else{writtting=writtting+","+onuser[i];}
          }
        }
        }
        if(lasttag!=tag){
          $("#chansn").html(tag);
          lasttag=tag;
        }
        if(writtting!=""){
          $("#writing").html(`<div id="div33"></div><strong id="writingg">${writtting}님이 글을 쓰는중</strong>`);
        }
        else{
          $("#writing").html('');
        }
      });
      document.getElementById('but1').addEventListener('click', function () {
    }, false);
      let lasttag="";
      let lastdo="";
      let dodo=1;
      setInterval(function() {
        var iod=$('#message').val();
        var iodd=iod.split("  ");
        var iod="";
        for(var i=0;i<iodd.length;i++){
          if(i!=iodd.length-1){
            iod=iod+iodd[i]+"<br> 󠀀󠀀 ";
          }
          else{
            iod=iod+iodd[i];
          }
        }
        $('#message').val(iod);
        if(document.hidden==false){
          doing="온라인";
        }
        else{
          doing="자리비움";
        }
        if($('#message').val()!=lastdo){
          if($('#message').val()!=""){
          doing="글쓰는중";
          if(dodo<50){
            dodo++;
          }
          else{
            dodo=1;
            lastdo=$('#message').val();
          }
          }
        }
        socket.emit('online',name,doing);
      }, 200);
      function mention(msg,user){
        var d=user;
        var aia=msg.split("@");
        var yes=1;
        for(var a=0;a<d.length;a++){
          if(d[a]!=0){
            yes=1;
            for(var i=0;i<d[a].length;i++){
              if(aia[1].charAt(i)!=d[a].charAt(i)){
                yes=0;
                break;
              }
            }
            if(yes==1){
              return d[a].length;
            }
          }
        }
        return 0;
      }
      //sdaddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddddd

        var re = /(?:(?=(?:http|https):)([a-zA-Z][-+.a-zA-Z\d]*):(?:((?:[-_.!~*'()a-zA-Z\d;?:@&=+$,]|%[a-fA-F\d]{2})(?:[-_.!~*'()a-zA-Z\d;\/?:@&=+$,\[\]]|%[a-fA-F\d]{2})*)|(?:(?:\/\/(?:(?:(?:((?:[-_.!~*'()a-zA-Z\d;:&=+$,]|%[a-fA-F\d]{2})*)@)?(?:((?:(?:(?:[a-zA-Z\d](?:[-a-zA-Z\d]*[a-zA-Z\d])?)\.)*(?:[a-zA-Z](?:[-a-zA-Z\d]*[a-zA-Z\d])?)\.?|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\[(?:(?:[a-fA-F\d]{1,4}:)*(?:[a-fA-F\d]{1,4}|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:(?:[a-fA-F\d]{1,4}:)*[a-fA-F\d]{1,4})?::(?:(?:[a-fA-F\d]{1,4}:)*(?:[a-fA-F\d]{1,4}|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}))?)\]))(?::(\d*))?))?|((?:[-_.!~*'()a-zA-Z\d$,;:@&=+]|%[a-fA-F\d]{2})+))|(?!\/\/))(\/(?:[-_.!~*'()a-zA-Z\d:@&=+$,]|%[a-fA-F\d]{2})*(?:;(?:[-_.!~*'()a-zA-Z\d:@&=+$,]|%[a-fA-F\d]{2})*)*(?:\/(?:[-_.!~*'()a-zA-Z\d:@&=+$,]|%[a-fA-F\d]{2})*(?:;(?:[-_.!~*'()a-zA-Z\d:@&=+$,]|%[a-fA-F\d]{2})*)*)*)?)(?:\?((?:[-_.!~*'()a-zA-Z\d;\/?:@&=+$,\[\]]|%[a-fA-F\d]{2})*))?)(?:\#((?:[-_.!~*'()a-zA-Z\d;\/?:@&=+$,\[\]]|%[a-fA-F\d]{2})*))?)/img;

          function makeHTML(textNode) {
              var source = textNode.data;
              return source.replace(re, function() {
                  var url = arguments[0];
                  var a = $('<a></a>').attr({'href': url, 'target': '_blank'}).text(url);
                  return url.match(/^https?:\/\/$/) ? url : $('<div></div>').append(a).html();
              });
          };

          function eachText(node, callback) {
              $.each(node.childNodes, function() {
                  if (this.nodeType != 8 && this.nodeName != 'A') {
                      this.nodeType != 1 ? callback(this) : eachText(this, callback);
                  }
              });
          };

      	function autolink(obj){
      		return obj.each(function() {
      	            var queue = [];
      	            eachText(this, function(e) {
      	                var html = makeHTML(e);
      	                if (html != e.data) {
      	                    queue.push([e, makeHTML(e)]);
      	                }
      	            });
      	            $.each(queue, function(i, x) {
      	                $(x[0]).replaceWith(x[1]);
      	            });
      	        });
      	};
    </script>
  </body>
</html>
